name: ridi-router
services:
  ridi-router-handler:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - RIDI_ROUTER_VERSION=${RIDI_ROUTER_VERSION}
    restart: on-failure
    environment:
      - RIDI_ROUTER_REGION=${RIDI_ROUTER_REGION}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SECRET_KEY=${SUPABASE_SECRET_KEY}
    volumes:
      - osm-data:/osm-data
    depends_on:
      osm-data-handler:
        condition: service_healthy
    healthcheck:
      test: curl --fail http://localhost:2727 || exit 1
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 5s

  osm-data-handler:
    build:
      context: ./osm-data-handler
      dockerfile: Dockerfile
    environment:
      - RIDI_ROUTER_REGION=${RIDI_ROUTER_REGION}
    volumes:
      - osm-data:/osm-data
    healthcheck:
      test: /bin/sh ./healthcheck.sh
      interval: 30s
      timeout: 10s
      retries: 60
      start_period: 5s

volumes:
  osm-data: {}
